name: Daily Carwow Sync
on:
  schedule:
    - cron: '0 1 * **'          # 毎日 01:00 UTC（JST 10:00）
  workflow_dispatch:             # 手動実行
jobs:
  scrape:
    runs-on: ubuntu-latest
    # ─── ここに "正しい" ENV を揃える ─────────────────────────
# .github/workflows/scrape.yml の env
env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  DEEPL_KEY: ${{ secrets.DEEPL_KEY }}
  GS_CREDS_JSON: ${{ secrets.GS_CREDS_JSON }}
  GS_SHEET_ID: ${{ secrets.GS_SHEET_ID }}   # ← ここに合わせる
    # ────────────────────────────────────────────────────────
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Write Google service-account key
        if: env.GS_CREDS_JSON != ''
        run: |
          mkdir -p secrets
          echo "$GS_CREDS_JSON" > secrets/gs_creds.json
      - name: Run crawler → Supabase & Google Sheets
        run: |
          python scrape.py            # すべて内部で実行
      - name: Upload raw dump (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-jsonl
          path: raw.jsonl
