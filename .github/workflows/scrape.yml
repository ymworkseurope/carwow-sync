name: Daily Carwow Sync

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ 02:00 = UTC 17:00 (å‰æ—¥)
    - cron: '0 17 * * *'
  workflow_dispatch:       # æ‰‹å‹•å®Ÿè¡Œ

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 180   # ãƒ¡ãƒ¼ã‚«ãƒ¼æ•°å¢—åŠ ã«å¯¾å¿œ

    env:
      SUPABASE_URL:   ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY:   ${{ secrets.SUPABASE_KEY }}
      DEEPL_KEY:      ${{ secrets.DEEPL_KEY }}
      GS_CREDS_JSON:  ${{ secrets.GS_CREDS_JSON }}
      GS_SHEET_ID:    ${{ secrets.GS_SHEET_ID }}
      GBP_TO_JPY:     '195'
      DEBUG_MODE:     'false'
      MAKES_FOR_BODYMAP: ""   # Discover ã‚¹ãƒ†ãƒƒãƒ—ã§ä¸Šæ›¸ã

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. å–å¾—
    - name: Checkout code
      uses: actions/checkout@v4

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ä¾å­˜
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Chrome
    - name: Setup Chrome
      uses: browser-actions/setup-chrome@latest
    - name: Setup ChromeDriver
      uses: nanasess/setup-chromedriver@v2

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Google SA
    - name: Setup Google credentials
      if: env.GS_CREDS_JSON != ''
      run: |
        mkdir -p secrets
        echo "$GS_CREDS_JSON" > secrets/gs_creds.json

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. å…¨ãƒ¡ãƒ¼ã‚«ãƒ¼å–å¾—
    - name: Discover all makers
      id: makers
      run: |
        echo "ğŸ“¡  Fetching maker list"
        MAKERS=$(python scripts/auto_maker_scraper.py --short)
        echo "MAKES_FOR_BODYMAP=${MAKERS}" >> "$GITHUB_ENV"
        echo "Detected makers: ${MAKERS}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. body_map ç”Ÿæˆ
    - name: Build body_type maps
      run: |
        IFS=' ' read -ra MAKES <<< "$MAKES_FOR_BODYMAP"
        for make in "${MAKES[@]}"; do
          echo "â–¶ Building body map for ${make}..."
          python body_type_mapper.py "${make}" || echo "Failed for ${make}, continuing..."
        done

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. ãƒ¡ã‚¤ãƒ³ã‚¯ãƒ­ãƒ¼ãƒ©
    - name: Run main crawler
      run: |
        echo "Starting crawler at $(date)"
        python scrape.py
        echo "Crawler finished at $(date)"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. ãƒ­ã‚°ä¿å­˜
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: crawler-logs-${{ github.run_number }}
        path: |
          *.log
          *.jsonl
          body_map_*.json
        retention-days: 7

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. å¤±æ•—é€šçŸ¥
    - name: Notify on failure
      if: failure()
      run: echo "Crawler failed â€“ check logs."
